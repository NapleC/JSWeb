<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <!--for iOS-->
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <!--for iOS End-->
    <!--Flexible-->
    <script src="libs/flexible.js"></script>
    <link type="text/css" rel="stylesheet/less" href="css/global.less">
    <link type="text/css" rel="stylesheet/less" href="css/index.less">
    <script src="libs/less.min.js"></script>

    <title>首页</title>
</head>
<body>
<script type="text/javascript" src="../js/jquery-1.8.3.min.js"></script>
<script type="text/javascript" src="../js/jquery.form.js"></script>
<script src="libs/jquery-3.3.1.js"></script>
<script src="js/utils.js"></script>
<script src="js/api.js"></script>

<form name="form" id="upPhoto" enctype="multipart/form-data">
    <!--点击上传 <input type="file" disabled="disabled" id="file" name="avatar" style="display: none;" accept="image/jpeg, image/gif,image/jpg"/>-->
    点击上传 <input type="file" id="file" name="avatar" accept="image/jpeg, image/gif,image/jpg"/>
</form>
<script>
    plus.nativeUI.actionSheet({cancel: "取消", buttons: [{title: "拍照上传"}, {title: "相册选择"}]}, function (e) {
        if (e.index == 0) return;
        if (e.index == 1) {
            plus.camera.getCamera(1).captureImage(function (p) {
                //上传图片
                avatarUpload(plus.io.convertLocalFileSystemURL(p));
            });
        } else if (e.index == 2) {
            plus.gallery.pick(function (p) {
                avatarUpload(p);
            }, {
                filter: "image",
                multiple: false //单选图片（true：多选图片）
            })
        }
    });

    //多选图片
    function galleryImgs() {
        // 从相册中选择图片
        plus.gallery.pick(function (e) {
            for (var i in e.files) {
                console.log(e.files[i]);//选取的图片数组
            }
        }, function (e) {
            mui.toast("取消选择图片");
        }, {
            filter: "image",
            multiple: true
        });
    }

    /**
     * @description上传头像
     * @param avatar 图片路径
     * */
    function avatarUpload(avatar) {
        var task = gettask('接口url', function (t, status) {//创建上传任务
            if (status == 200) {//返回状态
                var data = JSON.parse(t.responseText || '{}');
                mui.toast(data.msg || '上传成功');
                avatarObj.src = avatar;
            } else {
                _.toast("保存失败，请重试");
            }
        });
        task.addData('token', token);//后台接口设定的参数
        task.addData('privateToken', privateToken);//后台接口设定的参数
        task.addFile(avatar, {key: "avatar"});//所上传文件
        task.start();//开始上传任务
    }

    //创建上传任务
    function gettask(server, callback) {
        return plus.uploader.createUpload("服务器地址" + server, {
            method: "POST"
        }, callback);
    }

    //点击上传头像
    $("#file").trigger('click');//触发选择上传文件
    //监听图片change事件,表单提交来进行上传图片
    $("#file").bind("change", function () {
        var file = this.files[0] ? this.files[0] : null;
        if (!file) {
            return false;
        }
        mui.toast("正在上传...");
        // //开始ajax操作  上传图片
        // $("#upPhoto").ajaxSubmit({
        //     type: ASK_TYPE,//提交类型
        //     dataType: DATA_TYPE,//返回结果格式
        //     url: 'xxxx',//请求地址
        //     async: true, data: {xxxx},//请求数据
        //     success: function (data) {//请求成功后的函数
        //         if(data.status == 0) {//返回成功
        //             mui.toast("上传成功！");
        //         }else{
        //             mui.toast(data.msg || '上传失败，请重试');
        //         }
        //     },
        //     error:function(xhr){
        //         mui.toast('上传失败，请重试');
        //     }
        // });
    });
</script>
</body>
</html>
